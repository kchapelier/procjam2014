<html>
<head>
    <link href="http://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="css/vendors/jquery.onepage-scroll.css"/>
    <link rel="stylesheet" href="css/app/style.css"/>
</head>
<body>
<div class="main">
    <section class="intro">
        <div>
            <h1>Lets do something !</h1>
            <a class="next" href="#">Yes, let's do it !</a>
        </div>
    </section>
    <section class="names">
        <div>
            <h1>So... what are you going to do exactly ?</h1>
            <ul class="feminineFirstnames">
                <li>&nbsp;</li>
            </ul>
            <ul class="masculineFirstnames">
                <li>&nbsp;</li>
            </ul>
            <a class="generateNames" href="#">Generate a new set</a>
        </div>
    </section>
    <section class="music">
        <div>
            <h1>Aaaand ?</h1>

            <canvas id="canvas" width="1200" height="500"></canvas>
        </div>
    </section>
</div>
<script src="js/vendors/brain/brain-0.6.3.js"></script>
<script src="js/vendors/noisejs/perlin.js"></script>
<script src="js/vendors/jquery/jquery-2.1.1.min.js"></script>
<script src="js/vendors/jquery.onepage-scroll/jquery.onepage-scroll.min.js"></script>
<script src="js/app/lib/map2d.js"></script>
<script src="js/app/lib/weightedmarkovchain.js"></script>
<script src="js/app/lib/wmc-norway-cities-names.js"></script>
<script src="js/app/lib/wmc-japanese-feminine-firstnames.js"></script>
<script src="js/app/lib/wmc-japanese-masculine-firstnames.js"></script>
<script src="js/app/map-generation.js"></script>
<script>
    var seed = Math.random();
    console.log('seed', seed);
    noise.seed(seed);

    $(function () {
        var makeNeuralFunction = function (dataset) {
            var net = new brain.NeuralNetwork();

            net.train(dataset);

            return function () {
                return net.run.call(net, arguments);
            };
        };

        var roundUp = function (to, src) {
            return Math.round(src * to);
        };

        var generateNames = function () {
            var flist = $('.feminineFirstnames'),
                mlist = $('.masculineFirstnames'),
                i;

            flist.empty();
            mlist.empty();

            for (i = 0; i < 10; i++) {
                flist.append($('<li>', {text: japaneseFeminineFirstnames.get()}));
                mlist.append($('<li>', {text: japaneseMasculineFirstnames.get()}));
            }
        };

        var drawNoise = function () {
            var canvas = document.getElementById('canvas'),
                    context = canvas.getContext('2d'),
                    width = canvas.width,
                    height = canvas.height;

            var heightPropensityMap = getHeightPropensityMap(width, height);
            var heightMap = getHeightMap(width, height, heightPropensityMap);
            var continentMap = getContinentMap(heightMap);
            //var erodedMap = getErodedMap(heightMap);

            var preprocessedZones = [];

            var newValue = 250;
            continentMap.map(function (value, x, y) {
                if (value === 255) {
                    var count = 0,
                        points = [[x,y,value]];

                    newValue = newValue - 5;
                    value = newValue;

                    var zone = {
                        start : {
                            x : x,
                            y : y
                        },
                        value : value,
                        name : japaneseFeminineFirstnames.get() //TODO replace this
                    };

                    while (points.length > 0) {
                        count++;
                        var point = points.pop();

                        continentMap.set(point[0], point[1], value);

                        var left = [point[0] - 1, point[1], continentMap.get(point[0] - 1, point[1])],
                            right = [point[0] + 1, point[1], continentMap.get(point[0] + 1, point[1])],
                            up = [point[0], point[1] - 1, continentMap.get(point[0], point[1] - 1)],
                            down = [point[0], point[1] + 1, continentMap.get(point[0], point[1] + 1)];

                        [left, right, up, down].forEach(function (adjPoint) {
                            if(adjPoint[2] === 255) {
                                points.push(adjPoint);
                            }
                        });
                    }

                    zone.size = count;

                    preprocessedZones.push(zone);
                }

                return value;
            });

            var zones = {
                continents : [],
                islands : []
            };

            preprocessedZones.forEach(function (zone) {
                if (zone.size > 6000) {
                    zones.continents.push(zone);
                } else if (zone.size > 6) {
                    zones.islands.push(zone);
                } else {
                    continentMap.map(function(value, x, y) {
                        if(value === zone.value) {
                            //remove from the continent map
                            value = 0;
                            //remove from the height map
                            heightMap.set(x, y, heightMap.get(x, y) * 0.85);
                        }

                        return value;
                    });

                }
            });

            console.log(zones);

            var map = Map2D.clone(heightMap);
            map.map(function (value, x, y) {
                return Math.min(255, continentMap.get(x, y) ? (value - 30) * 1.5 : value / 1.75);
                //return Math.min(255, continentMap.get(x, y) ? (10 + value - average) * (6) : 0);
            });

            Map2D.draw(context, 0, 0, map);

            //TODO use erosion simulation to get more grainy details in the continents
            //TODO lake / rivers
        };

        var part2 = function () {
            console.log('part2');
            $('.names ul').animate({
                opacity: 1
            })
        };

        var part3 = function () {
            console.log('part3');
        };

        $('.main').onepage_scroll({
            sectionContainer: "section",
            easing: "ease",
            animationTime: 700,
            pagination: true,
            updateURL: false,
            loop: false,
            keyboard: true,
            direction: "vertical",
            afterMove: function (index) {
                if (index === 2) {
                    part2();
                } else if (index === 3) {
                    part3();
                }
            }
        });

        $('.next').on('click', function (e) {
            e.preventDefault();
            $('.main').moveDown();
        });

        $('.generateNames').on('click', function (e) {
            e.preventDefault();
            generateNames();
        });

        generateNames();
        setTimeout(drawNoise, 100);
    });
</script>
</body>
</html>
